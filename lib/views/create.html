<script type="text/javascript">
function openWin() {
    window.open('/validate', "_blank", "height=200,width=400");
}

function unpair() {
    Cookies.remove('uuid');
    $('#pairedIcon').css('visibility','hidden');
    $('#pairedTip').css('visibility','hidden');
}
</script>

<div class="center">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="top_index">
            <a href="/">
                <img width="260" src="/logo13.png" />
                <div class="tagline"> Share once, and only once </div>
            </a>
        </div>

        <br/>
        <br/>
        <br/>
    </div>

    <div class="input-group input-group-lg-textarea center">
        <textarea class="form-control" id="secret" placeholder="Enter the text you want to share..."></textarea>
    </div>
    {{#> notices }}
    {{/notices}}

    <div class="error center"></div>
    <br /> 
    
    <!-- popup for pairing / sending to mobile -->

    <div id="light" class="white_content">
        <h2>Pair your mobile</h2>
        To send a message <to></to> your mobile device, you need to pair it first to this browser. Type the following code in the whisper.ws mobile app
        <br>
        <br>
        <br>
        <div class="row"> 
            <div class="pairingCode" id="pairingCode" style="font-family: courier; font-size: 24pt"></div>
        </div>
        <br />
        <br />
        <br />
        <br />
        <input type="button" value="Close" style="position:relative; bottom:20px" onclick="document.getElementById('light').style.display='none';document.getElementById('fade').style.display='none'">
        </input>
    </div>


    <div class="container">
        <div class="row">
            <div class="col-sm-3" style="float:none;display:inline-block;">
                <button id="sendMobile" class="myButton"> Send to Mobile </button>
                <div class="tooltip2">
                    <img id="pairedIcon" src="/images/paired2.png" width="20" alt="Paired to a mobile. Click to unpair" onclick="unpair();"/>
                    <span id="pairedTip" class="tooltiptext2">You are currently paired to a mobile device. Click this to unpair</span>
                </div>                
            </div>
            <div class="col-sm-3" style="float:none;display:inline-block;">
                <button id="create" class="myButton"> Generate Secure Link </button>
                <div id="fade" class="black_overlay"></div>
            </div>
        </div>
    </div>
    <br  />

    <div class="mobilecollapse">
        <p class="result"></p>                                
    </div>

    <div class="linkcollapse">
        <input class="urldiv center" id="url" /> 
        <button id="copybutton" data-clipboard-target="#url" class="btn">
            <img class="clippy" src="/images/copy.svg" height="17" alt="Copy to clipboard" />
        </button>
        <p class="notices"> Send this to someone you want to share your text with. It will expire in 24 hrs and can only be viewed once. </p>                                
        <br /> 
        <br /> 
    </div>


</div>


<script type="text/javascript">
    // the textarea where you enter your secret
    $('#secret').on('input', function() {
        var max = 240;
        var interval = 80;
        var lines = 3;
        
        // increase the size of the textbox every 3 lines (for a max of three times)
        if($("#secret").val().split(/\n/).length / lines > $("#secret").height() / interval && $("#secret").height() < max) {
            var newheight = Number.parseInt(($("#secret").val().split(/\n/).length / lines + 1)) * interval;
            if (newheight > max) newheight = max; 
            $("#secret").height(newheight + 'px');   
        }
        else if(($("#secret").val().split(/\n/).length / lines + 1 < $("#secret").height() / interval) && $("#secret").height() > interval) {
            var newheight = Number.parseInt(($("#secret").val().split(/\n/).length / lines + 1)) * interval;
            if (newheight < interval) newheight = interval ; 
            console.log(newheight)
            $("#secret").height(newheight + 'px');   
        }
    });
</script>

<script type="text/javascript">

    // ON PAGE LOAD
    var sendMobileBtn = document.querySelector('#sendMobile');
    var uuid;
    
    // tell if we've been paired before'
    var paired = Cookies.get('uuid') ? true: false;
    if (!paired) {
        $('#pairedIcon').css('visibility','hidden');       
        $('#pairedTip').css('visibility','hidden');       
    }

    sendMobile.addEventListener('click', function(event) {


        // cookie will be set if this browser has been paired with a mobile device
        if (Cookies.get('uuid')) {
            // get the secret and send to mobile 
            var mysecret = $('#secret').val();
            // ugly hack for now to get the uuid
            if (!uuid) {
                uuid = Cookies.get('uuid');
            }

            $('.mobilecollapse').hide(); 
            $('.linkcollapse').hide();

            // create a secret url
            if (mysecret != '') {
                $('.error').text('');
                console.log(uuid)
                $.post("/i/url", { 
                    secret: mysecret 
                }).done(function(data){                    
                    // send the URL to any connected paired mobile devices
                    var url = data.webUrl;
                    $.post("/mobile", { 
                        url: url,
                        uuid: uuid
                    }).done(function(data){
                        console.log('sent: ' + data);
                        $('.mobilecollapse').fadeIn('slow');
                        $('.mobilecollapse').text('Message was sent. Check your mobile device for the message.') 
                    }).error(function(error) {
                        console.log('error here: ' + JSON.stringify(error));
                        $('.mobilecollapse').fadeIn('fast');
                        $('.mobilecollapse').text('This browser does not seem to be paired. Try pairing again from mobile.') 
                        unpair();
                    });

                }).error(function(error) {
                    $('.error').text(error.responseText);
                    console.log(error);
                });
            }            
            else {
                $('.error').text('Please enter text');
            }
        }        
        else {
            document.getElementById('light').style.display='block';
            document.getElementById('fade').style.display='block'

            // generate a new pairing code
            $.post("/pair", { 

            }).done(function(data){                    
                $('#pairingCode').text(data.code);
                listenForPair(data.code);

                // keep generating a new one every 60s
                setInterval(function() {
                    if (!paired) {
                        $.post("/pair", { 

                        }).done(function(data){                    
                            listenForPair(data.code);
                            $('#pairingCode').text(data.code)
                        });
                    }
                }, 60000);
            });

            // connect to a websocket to be notified when pairing is complete
            var listenForPair = function(code) {
                var ws = new WebSocket('{{wsUrl}}?code=' + code);
                ws.onmessage = (e) => {
                    console.log('receiving an incoming pairing code confirmation: ' + e.data);
                    Cookies.set('uuid', e.data);
                    uuid = e.data;
                    paired = true;
                    $('#pairingCode').text('Paired ✓');
                    $('#pairedIcon').css('visibility','');       
                    $('#pairedTip').css('visibility','');       
                };
            }

        }
    });


    // ON PAGE LOAD
    var createBtn = document.querySelector('#create');
    
    createBtn.addEventListener('click', function(event) {
        // ON SUBMIT
        $('.mobilecollapse').hide(); 

        var mysecret = $('#secret').val();
        if (mysecret != '') {
            $('.error').text('');
            $.post("/i/url", { 
                secret: mysecret 
            }).done(function(data){
                var url = data.webUrl;
                $('#url').val(url);
                $('.linkcollapse').fadeIn('fast');
                if (document.queryCommandSupported('copy')) {
                    $('#copybutton').show();
                }
            }).error(function(error) {
                $('.error').text(error.responseText);
                console.log(error);
            });
        }
        else {
            $('.error').text('Please enter text');
        }
    });
</script>
    
<script type="text/javascript">
    $('#secret').textcomplete([
        { // emoji strategy
            match: /\B:([\-+\w]*)$/,
            search: function (term, callback) {
                callback($.map(emojies, function (emoji) {
                    return emoji.indexOf(term) === 0 ? emoji : null;
                }));
            },
            template: function (value) {
                return '<img width="20" src="/images/emojis/' + value + '.png"></img> ' + value;
            },
            replace: function (value) {
                return ':' + value + ': ';
            },
            index: 1
        },
    ], {
        onKeydown: function (e, commands) {
            if (e.ctrlKey && e.keyCode === 74) { // CTRL-J
                return commands.KEY_ENTER;
            }
        }
    });        
    // Use the browser's built-in functionality to quickly and safely escape the
    // string
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        console.log(div.innerHTML);
        return div.innerHTML;
    };
</script>

<script type="text/javascript">
    // ON PAGE LOAD
    var clipboard = new Clipboard('.btn');
    $('#thesecret').append('<button id="insetcopybutton" class="btn" data-clipboard-target="#thesecret"><img class="clippy" width="13" src="/images/copy.svg" alt="Copy to clipboard"></button>');
    clipboard.on('success', function(e) {
        showTooltip(e.trigger, 'Copied!');
        e.clearSelection();
    });

    clipboard.on('error', function(e) {
        if (/Macintosh/i.test(navigator.userAgent)) {
            actionMsg = 'Press ⌘-C to copy';
            showTooltip(e.trigger, actionMsg);
        }

    });
</script>
